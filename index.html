<!DOCTYPE html>
<html lang="et">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Ilm Ultra</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-day: linear-gradient(180deg, #4facfe 0%, #00f2fe 100%);
            --bg-night: linear-gradient(180deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            --card-bg: rgba(255,255,255,0.15);
            --card-blur: blur(15px);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
            background: var(--bg-day); /* Vaikimisi p√§ev */
            margin: 0; color: white; min-height: 100vh; overflow-x: hidden; transition: background 1s ease;
        }
        body.is-night { background: var(--bg-night); }

        /* --- ANIMATSIOONID --- */
        .weather-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        
        /* P√§ike */
        .sun-anim {
            position: absolute; top: -50px; right: -50px; width: 200px; height: 200px;
            background: radial-gradient(circle, rgba(255,255,200,0.8) 0%, rgba(255,255,255,0) 70%);
            border-radius: 50%; animation: spin 30s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* T√§hed (√ñ√∂sel) */
        .stars-anim {
             background-image: 
                radial-gradient(2px 2px at 20px 30px, #eee, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 40px 70px, #fff, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 50px 160px, #ddd, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 90px 40px, #fff, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 130px 80px, #fff, rgba(0,0,0,0));
            background-size: 200px 200px;
            animation: twinkle 5s infinite;
        }
        @keyframes twinkle { 50% { opacity: 0.5; } }

        /* Vihm/Lumi */
        .rain-anim { background: url('https://i.imgur.com/VuT5t6W.png'); animation: rain 1s linear infinite; }
        @keyframes rain { 0% { background-position: 0 0; } 100% { background-position: -20px 500px; } }
        .snow-anim { background-image: radial-gradient(4px 4px at 100px 50px, #fff, transparent), radial-gradient(6px 6px at 200px 150px, #fff, transparent); background-size: 200px 200px; animation: snow 3s linear infinite; }
        @keyframes snow { 100% { background-position: 500px 500px; } }

        /* --- UI --- */
        .container { padding: 60px 20px 30px 20px; max-width: 600px; margin: 0 auto; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        
        /* Nupud n√º√ºd ilusti √ºmmargused */
        .location-btn { 
            width: 44px; height: 44px; display: flex; justify-content: center; align-items: center;
            background: var(--card-bg); border: none; border-radius: 50%; color: white; cursor: pointer; backdrop-filter: var(--card-blur); font-size: 18px;
        }
        .search-box { flex: 1; margin: 0 15px; position: relative; }
        .search-input { width: 100%; padding: 12px 20px; border-radius: 25px; border: none; background: var(--card-bg); color: white; backdrop-filter: var(--card-blur); outline: none; font-size: 16px; }
        .search-input::placeholder { color: rgba(255,255,255,0.6); }
        .search-results { position: absolute; top: 50px; width: 100%; background: rgba(20,20,40,0.95); border-radius: 15px; overflow: hidden; display: none; z-index: 100; backdrop-filter: blur(20px); }
        .search-item { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; }

        /* Praegune ilm */
        .current-weather { text-align: center; margin-bottom: 40px; }
        .city-name { font-size: 38px; font-weight: 700; text-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .temp-huge { font-size: 100px; font-weight: 200; letter-spacing: -4px; margin: 5px 0; line-height: 1; }
        .desc { font-size: 24px; font-weight: 500; text-transform: capitalize; margin-bottom: 5px; opacity: 0.9; }
        
        /* Detailid */
        .details-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 30px; }
        .detail-card { background: var(--card-bg); backdrop-filter: var(--card-blur); border-radius: 18px; padding: 15px; text-align: center; }
        .detail-icon { font-size: 22px; margin-bottom: 8px; opacity: 0.8; }
        .detail-val { font-size: 17px; font-weight: 600; }
        .detail-label { font-size: 13px; opacity: 0.6; }

        /* 7 P√§eva & Tunnivaade */
        .forecast-title { font-size: 20px; font-weight: 600; margin-bottom: 15px; opacity: 0.9; }
        .forecast-list { display: flex; flex-direction: column; gap: 10px; }
        
        .forecast-item { background: var(--card-bg); border-radius: 20px; backdrop-filter: var(--card-blur); overflow: hidden; transition: all 0.3s ease; }
        .forecast-summary { 
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px; cursor: pointer;
        }
        .f-day { width: 110px; font-weight: 600; font-size: 17px; }
        .f-icon { font-size: 22px; text-align: center; width: 40px; }
        .f-temp { text-align: right; width: 110px; font-size: 17px; }
        .temp-max { font-weight: 600; margin-left: 10px; }
        .temp-min { opacity: 0.6; }

        /* Tunnivaate peidetud osa */
        .hourly-details { 
            display: none; /* Vaikimisi peidetud */
            padding: 0 0 20px 20px;
            overflow-x: auto; /* Horisontaalne kerimine */
            white-space: nowrap;
             scrollbar-width: none; /* Peida scrollbar Firefox */
        }
        .hourly-details::-webkit-scrollbar { display: none; /* Peida scrollbar Safari/Chrome */ }

        .hour-card {
            display: inline-block;
            text-align: center;
            padding: 15px 10px;
            background: rgba(0,0,0,0.1);
            border-radius: 15px;
            margin-right: 10px;
            min-width: 70px;
        }
        .h-time { font-size: 14px; opacity: 0.7; margin-bottom: 5px; }
        .h-icon { font-size: 24px; margin-bottom: 8px; }
        .h-temp { font-size: 18px; font-weight: 600; }
        .h-pop { font-size: 12px; color: #90cee6; margin-top: 5px; }

        /* Avatud olek */
        .forecast-item.open { background: rgba(255,255,255,0.25); }
        .forecast-item.open .hourly-details { display: block; }

    </style>
</head>
<body>

    <div id="anim-layer" class="weather-bg"></div>

    <div class="container">
        <div class="top-bar">
            <button class="location-btn" onclick="getMyLocation()"><i class="fas fa-location-arrow"></i></button>
            <div class="search-box">
                <input type="text" class="search-input" id="citySearch" placeholder="Otsi linna..." onkeyup="searchCity(this.value)">
                <div id="searchResults" class="search-results"></div>
            </div>
            <button class="location-btn" style="opacity: 0.5"><i class="far fa-star"></i></button>
        </div>

        <div class="current-weather" id="main-view">
            <div class="city-name" id="cityName">Laen...</div>
            <div class="desc" id="weatherDesc">...</div>
            <div class="temp-huge" id="currentTemp">--¬∞</div>
            <div style="font-size: 18px; opacity: 0.8">H: <span id="maxTemp">--</span>¬∞ L: <span id="minTemp">--</span>¬∞</div>
        </div>

        <div class="details-grid">
            <div class="detail-card">
                <div class="detail-icon"><i class="fas fa-temperature-high"></i></div>
                <div class="detail-val" id="feelsLike">--¬∞</div>
                <div class="detail-label">Tundub nagu</div>
            </div>
            <div class="detail-card">
                <div class="detail-icon"><i class="fas fa-wind"></i></div>
                <div class="detail-val" id="windSpeed">-- km/h</div>
                <div class="detail-label">Tuul</div>
            </div>
            <div class="detail-card">
                <div class="detail-icon"><i class="fas fa-droplet"></i></div>
                <div class="detail-val" id="rainProb">--%</div>
                <div class="detail-label">Sadu</div>
            </div>
        </div>

        <div class="forecast-title"><i class="far fa-calendar-alt"></i> 7 p√§eva ennustus (vajuta)</div>
        <div class="forecast-list" id="forecastList"></div>
    </div>

    <script>
        let currentLat = 59.4370; let currentLon = 24.7536; let currentCity = "Tallinn";

        function getWeatherInfo(code) {
            if (code === 0) return ['‚òÄÔ∏è', 'Selge', 'sun'];
            if (code >= 1 && code <= 3) return ['‚õÖ', 'Pilvine', 'cloud'];
            if (code >= 45 && code <= 48) return ['üå´Ô∏è', 'Udu', 'cloud'];
            if (code >= 51 && code <= 67) return ['üåßÔ∏è', 'Vihm', 'rain'];
            if (code >= 71 && code <= 77) return ['‚ùÑÔ∏è', 'Lumi', 'snow'];
            if (code >= 80 && code <= 82) return ['üå¶Ô∏è', 'Hoovihm', 'rain'];
            if (code >= 95) return ['‚ö°', '√Ñike', 'rain'];
            return ['‚òÅÔ∏è', 'Pilves', 'cloud'];
        }

        // LAE ANDMED (Lisatud hourly ja sunrise/sunset)
        async function loadWeather(lat, lon, name) {
            document.getElementById('cityName').innerText = name;
            // K√ºsib n√º√ºd ka tunnip√µhist infot ja p√§ikeset√µusu/loojangut
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,apparent_temperature,weather_code,wind_speed_10m,is_day&hourly=temperature_2m,weather_code,precipitation_probability&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max,sunrise,sunset&timezone=auto`;

            try {
                const res = await fetch(url);
                const data = await res.json();
                renderApp(data);
            } catch (e) { alert("Viga andmete laadimisel!"); console.error(e); }
        }

        function renderApp(data) {
            const current = data.current;
            const daily = data.daily;
            const hourly = data.hourly;
            const info = getWeatherInfo(current.weather_code);

            // √ñ√ñ / P√ÑEV Loogika
            const isNight = current.is_day === 0;
            if (isNight) {
                document.body.classList.add('is-night');
                if (info[2] === 'sun') info[2] = 'stars'; // Selge √∂√∂ = t√§hed
            } else {
                document.body.classList.remove('is-night');
            }
            setAnimation(info[2]);

            // Praegune ilm
            document.getElementById('currentTemp').innerText = Math.round(current.temperature_2m) + "¬∞";
            document.getElementById('weatherDesc').innerText = info[1];
            document.getElementById('maxTemp').innerText = Math.round(daily.temperature_2m_max[0]);
            document.getElementById('minTemp').innerText = Math.round(daily.temperature_2m_min[0]);
            document.getElementById('feelsLike').innerText = Math.round(current.apparent_temperature) + "¬∞";
            document.getElementById('windSpeed').innerText = Math.round(current.wind_speed_10m) + " km/h";
            document.getElementById('rainProb').innerText = daily.precipitation_probability_max[0] + "%";

            // 7 P√ÑEVA + TUNNIVAADE
            const list = document.getElementById('forecastList');
            list.innerHTML = '';

            for(let i = 1; i < 7; i++) {
                const date = new Date(daily.time[i]);
                const dayName = date.toLocaleDateString('et-EE', { weekday: 'long' });
                const dayInfo = getWeatherInfo(daily.weather_code[i]);
                
                // Tunnivaate genereerimine selle p√§eva jaoks
                let hourlyHTML = '';
                // Iga p√§ev on 24h. Leiame √µiged indeksid tunnivaate massiivist.
                let startIdx = i * 24; 
                let endIdx = startIdx + 24;

                // N√§itame iga 3. tundi (et s√§√§sta ruumi)
                for(let h = startIdx; h < endIdx; h += 3) {
                    const hourDate = new Date(hourly.time[h]);
                    const hourTime = hourDate.getHours() + ":00";
                    const hInfo = getWeatherInfo(hourly.weather_code[h]);
                    hourlyHTML += `
                        <div class="hour-card">
                            <div class="h-time">${hourTime}</div>
                            <div class="h-icon">${hInfo[0]}</div>
                            <div class="h-temp">${Math.round(hourly.temperature_2m[h])}¬∞</div>
                            <div class="h-pop"><i class="fas fa-droplet"></i> ${hourly.precipitation_probability[h]}%</div>
                        </div>
                    `;
                }

                const item = document.createElement('div');
                item.className = 'forecast-item';
                item.innerHTML = `
                    <div class="forecast-summary" onclick="this.parentElement.classList.toggle('open')">
                        <div class="f-day">${dayName.charAt(0).toUpperCase() + dayName.slice(1)}</div>
                        <div class="f-icon">${dayInfo[0]}</div>
                        <div class="f-temp">
                            <span class="temp-min">${Math.round(daily.temperature_2m_min[i])}¬∞</span>
                            <span class="temp-max">${Math.round(daily.temperature_2m_max[i])}¬∞</span>
                        </div>
                    </div>
                    <div class="hourly-details">
                        ${hourlyHTML}
                    </div>
                `;
                list.appendChild(item);
            }
        }

        function setAnimation(type) {
            const layer = document.getElementById('anim-layer');
            layer.innerHTML = ''; layer.className = 'weather-bg';
            if (type === 'sun') {
                const sun = document.createElement('div'); sun.className = 'sun-anim'; layer.appendChild(sun);
            } else if (type === 'stars') {
                layer.classList.add('stars-anim');
            } else if (type === 'rain') layer.classList.add('rain-anim');
            else if (type === 'snow') layer.classList.add('snow-anim');
        }

        function getMyLocation() {
            if (navigator.geolocation) {
                document.getElementById('cityName').innerText = "Otsin...";
                navigator.geolocation.getCurrentPosition(pos => {
                    const lat = pos.coords.latitude; const lon = pos.coords.longitude;
                    // Leiame linna nime
                    fetch(`https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=et`)
                        .then(r => r.json())
                        .then(data => {
                            let name = "Minu Asukoht";
                            if (data.results && data.results[0]) name = data.results[0].name;
                             loadWeather(lat, lon, name);
                        });
                }, () => { alert("GPS viga."); loadWeather(currentLat, currentLon, "Tallinn"); });
            }
        }

        async function searchCity(query) {
            const resultsDiv = document.getElementById('searchResults');
            if (query.length < 3) { resultsDiv.style.display = 'none'; return; }
            const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${query}&count=5&language=et&format=json`);
            const data = await res.json();
            if (data.results) {
                resultsDiv.innerHTML = ''; resultsDiv.style.display = 'block';
                data.results.forEach(city => {
                    const div = document.createElement('div');
                    div.className = 'search-item';
                    div.innerText = `${city.name}, ${city.country}`;
                    div.onclick = () => {
                        loadWeather(city.latitude, city.longitude, city.name);
                        resultsDiv.style.display = 'none'; document.getElementById('citySearch').value = '';
                    };
                    resultsDiv.appendChild(div);
                });
            }
        }

        loadWeather(currentLat, currentLon, currentCity);
    </script>
</body>
</html>
